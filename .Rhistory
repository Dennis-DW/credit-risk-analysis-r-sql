caption = "Note: 'Unclassified' refers to transactions with missing category information",
x = "",
y = "Default Rate (%)",
color = "Risk Level"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
plot.caption = element_text(size = 10, color = "grey40", face = "italic"), # Styles the note
panel.grid.major.y = element_blank()
)
# 4. Save
print(plot)
ggsave("presentation_plots/3_risk_lollipop.png", plot, width = 8, height = 6)
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
# 1. Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
# 2. Get Data
# We label NULLs as 'Unclassified' here
query <- "
SELECT
CASE WHEN t.category IS NULL OR category = ''THEN 'Unclassified' ELSE t.category END as category,
AVG(u.default_flag) * 100 as default_rate
FROM transactions t
JOIN users u ON t.user_id = u.user_id
GROUP BY 1
ORDER BY default_rate ASC
"
df_risk <- dbGetQuery(conn, query)
# 3. Create Lollipop Chart
plot <- ggplot(df_risk, aes(x = reorder(category, default_rate), y = default_rate)) +
geom_segment(aes(x=reorder(category, default_rate), xend=category, y=0, yend=default_rate), color="grey") +
geom_point(aes(color = default_rate), size=5) +
scale_color_gradient(low = "#3498DB", high = "#C0392B") +
coord_flip() +
labs(
title = "Risk Ranking by Category",
subtitle = "Red indicates categories with the highest default rates",
# ADDED CAPTION HERE
caption = "Note: 'Unclassified' refers to transactions with missing category information",
x = "",
y = "Default Rate (%)",
color = "Risk Level"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
plot.caption = element_text(size = 10, color = "grey40", face = "italic"), # Styles the note
panel.grid.major.y = element_blank()
)
# 4. Save
print(plot)
ggsave("presentation_plots/3_risk_lollipop.png", plot, width = 8, height = 6)
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
# 1. Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
# 2. Run the specific "Latest Record" Query
query <- "
SELECT *
FROM transactions t1
WHERE transaction_date = (
SELECT MAX(transaction_date)
FROM transactions t2
WHERE t2.user_id = t1.user_id
)
"
df_latest <- dbGetQuery(conn, query)
# 3. Process Data for Plotting
# Convert text date to actual Date object
df_latest$transaction_date <- as.POSIXct(df_latest$transaction_date)
# Handle NULL categories for cleaner legend
df_latest$category <- ifelse(is.na(df_latest$category), "Unclassified", df_latest$category)
# 4. Create Timeline Scatter Plot
plot <- ggplot(df_latest, aes(x = transaction_date, y = amount, color = category)) +
geom_point(alpha = 0.7, size = 3) + # Semi-transparent dots
scale_y_log10(labels = comma) + # Log scale makes it easier to see small vs big amounts
scale_color_brewer(palette = "Set1") + # Distinct colors for categories
labs(
title = "User Recency Snapshot",
subtitle = "Each dot represents a user's most recent transaction",
caption = "Y-axis is on a Log Scale to show wide range of values",
x = "Date of Last Transaction",
y = "Amount (KES) [Log Scale]",
color = "Category"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
legend.position = "right",
panel.grid.minor = element_blank()
)
# 5. Save
print(plot)
ggsave("presentation_plots/4_latest_activity_scatter.png", plot, width = 10, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
#Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
query <- "
SELECT *
FROM transactions t1
WHERE transaction_date = (
SELECT MAX(transaction_date)
FROM transactions t2
WHERE t2.user_id = t1.user_id
)
"
df_latest <- dbGetQuery(conn, query)
#Process Data for Plotting
#Convert text date to actual Date object
df_latest$transaction_date <- as.POSIXct(df_latest$transaction_date)
# Handle NULL categories for cleaner legend
df_latest$category <- ifelse(is.na(df_latest$category), "Unclassified", df_latest$category)
#Create Timeline Scatter Plot
plot <- ggplot(df_latest, aes(x = transaction_date, y = amount, color = category)) +
geom_point(alpha = 0.7, size = 3) +
scale_y_log10(labels = comma) +
scale_color_brewer(palette = "Set1") +
labs(
title = "User Recency Snapshot",
subtitle = "Each dot represents a user's most recent transaction",
caption = "Y-axis is on a Log Scale to show wide range of values",
x = "Date of Last Transaction",
y = "Amount (KES) [Log Scale]",
color = "Category"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
legend.position = "right",
panel.grid.minor = element_blank()
)
# 5. Save
print(plot)
ggsave("presentation_plots/4_latest_activity_scatter.png", plot, width = 10, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
# 1. Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
# 2. Run the Daily Volume Query
query <- "
SELECT
DATE(transaction_date) as day,
COUNT(*) as transaction_volume
FROM
transactions
WHERE
transaction_date >= DATE((SELECT MAX(transaction_date) FROM transactions), '-30 days')
GROUP BY
day
ORDER BY
day;
"
df_trend <- dbGetQuery(conn, query)
# 3. Process Data
# Convert the 'day' string to a real Date object for proper plotting
df_trend$day <- as.Date(df_trend$day)
# 4. Create Area Chart (Trend)
plot <- ggplot(df_trend, aes(x = day, y = transaction_volume)) +
# Area fill under the line gives a sense of 'volume'
geom_area(fill = "#8E44AD", alpha = 0.2) +
# The main trend line
geom_line(color = "#8E44AD", size = 1.2) +
# Points to highlight specific days
geom_point(color = "#8E44AD", size = 2) +
# Add trend line (smooth) to see the general direction
geom_smooth(method = "loess", se = FALSE, color = "orange", linetype = "dashed", size = 0.8) +
labs(
title = "Daily Transaction Trends (Last 30 Days)",
subtitle = "Purple line shows daily volume; Orange dashed line shows the moving average",
x = "Date",
y = "Number of Transactions"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(angle = 45, hjust = 1), # Tilts date labels so they don't overlap
panel.grid.minor = element_blank()
) +
scale_x_date(date_labels = "%b %d", date_breaks = "3 days") # Shows "Jan 01" format every 3 days
# 5. Save
print(plot)
ggsave("presentation_plots/5_daily_trend.png", plot, width = 10, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
# 1. Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
# 2. Run the Top Users Query
query <- "
SELECT
user_id,
COUNT(transaction_id) as transaction_count
FROM
transactions t
GROUP BY
user_id
ORDER BY
transaction_count DESC
LIMIT 5
"
df_top <- dbGetQuery(conn, query)
# 3. Process Data
# Convert user_id to a Factor (Category) so it plots as distinct bars, not numbers
# We reorder it so the highest value is at the top
df_top$user_id <- factor(df_top$user_id, levels = df_top$user_id[order(df_top$transaction_count)])
# Create a 'Rank' column to help us color the bars (Gold, Silver, Bronze, etc.)
df_top$rank <- rank(-df_top$transaction_count)
df_top$color_group <- case_when(
df_top$rank == 1 ~ "Top 1 (Gold)",
df_top$rank == 2 ~ "Top 2 (Silver)",
df_top$rank == 3 ~ "Top 3 (Bronze)",
TRUE ~ "Others"
)
# 4. Create Ranked Bar Chart
plot <- ggplot(df_top, aes(x = user_id, y = transaction_count, fill = color_group)) +
geom_col(width = 0.7) +
# Custom Colors for the Podium Finish
scale_fill_manual(values = c(
"Top 1 (Gold)" = "#F1C40F",
"Top 2 (Silver)" = "#BDC3C7",
"Top 3 (Bronze)" = "#D35400",
"Others" = "#34495E"
)) +
# Add labels inside the bars
geom_text(aes(label = transaction_count), hjust = 1.5, color = "white", fontface = "bold") +
coord_flip() + # Horizontal bars are easier to read for rankings
labs(
title = "Top 5 Most Active Users",
subtitle = "User 1190 and 1099 lead with the highest transaction frequency",
x = "User ID",
y = "Number of Transactions",
fill = "Rank"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom", # Moves legend to bottom to save space
panel.grid.major.y = element_blank() # Removes grid lines for cleaner look
)
# 5. Save
print(plot)
ggsave("presentation_plots/6_top_users_ranked.png", plot, width = 8, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
#Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
#Top Users Query
query <- "
SELECT
user_id,
COUNT(transaction_id) as transaction_count
FROM
transactions t
GROUP BY
user_id
ORDER BY
transaction_count DESC
LIMIT 5
"
df_top <- dbGetQuery(conn, query)
#Process Data
#Convert user_id to a Factor (Category) so it plots as distinct bars, not numbers
df_top$user_id <- factor(df_top$user_id, levels = df_top$user_id[order(df_top$transaction_count)])
# Create a 'Rank' column to help us color the bars (Gold, Silver, Bronze, etc.)
df_top$rank <- rank(-df_top$transaction_count)
df_top$color_group <- case_when(
df_top$rank == 1 ~ "Top 1 (Gold)",
df_top$rank == 2 ~ "Top 2 (Silver)",
df_top$rank == 3 ~ "Top 3 (Bronze)",
TRUE ~ "Others"
)
# 4. Create Ranked Bar Chart
plot <- ggplot(df_top, aes(x = user_id, y = transaction_count, fill = color_group)) +
geom_col(width = 0.7) +
# Custom Colors for the Podium Finish
scale_fill_manual(values = c(
"Top 1 (Gold)" = "#F1C40F",
"Top 2 (Silver)" = "#BDC3C7",
"Top 3 (Bronze)" = "#D35400",
"Others" = "#34495E"
)) +
# Add labels inside the bars
geom_text(aes(label = transaction_count), hjust = 1.5, color = "white", fontface = "bold") +
coord_flip() + # Horizontal bars are easier to read for rankings
labs(
title = "Top 5 Most Active Users",
subtitle = "User 1190 and 1099 lead with the highest transaction frequency",
x = "User ID",
y = "Number of Transactions",
fill = "Rank"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom", # Moves legend to bottom to save space
panel.grid.major.y = element_blank() # Removes grid lines for cleaner look
)
# 5. Save
print(plot)
ggsave("presentation_plots/6_top_users_ranked.png", plot, width = 8, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
# 1. Setup Folder and Connection
dir.create("presentation_plots", showWarnings = FALSE)
conn <- dbConnect(RSQLite::SQLite(), "pezesha_data.db")
# 2. Run the Top Users Query
query <- "
SELECT
user_id,
COUNT(transaction_id) as transaction_count
FROM
transactions t
GROUP BY
user_id
ORDER BY
transaction_count DESC
LIMIT 5
"
df_top <- dbGetQuery(conn, query)
# 3. Process Data for Coloring
# Convert user_id to Factor to keep the sorted order in the chart
df_top$user_id <- factor(df_top$user_id, levels = df_top$user_id[order(df_top$transaction_count)])
# FIX: Use simple row numbers (1, 2, 3...) to guarantee ranks work even if there are ties
df_top$simple_rank <- 1:nrow(df_top)
df_top$color_group <- case_when(
df_top$simple_rank == 1 ~ "1st Place",
df_top$simple_rank == 2 ~ "2nd Place",
df_top$simple_rank == 3 ~ "3rd Place",
TRUE ~ "Top 5 Runners-up"
)
# Define the order so the Legend looks logical (1st, 2nd, 3rd, Others)
df_top$color_group <- factor(df_top$color_group,
levels = c("1st Place", "2nd Place", "3rd Place", "Top 5 Runners-up"))
# 4. Create Ranked Bar Chart
plot <- ggplot(df_top, aes(x = user_id, y = transaction_count, fill = color_group)) +
geom_col(width = 0.7) +
# Explicitly map the colors
scale_fill_manual(values = c(
"1st Place" = "#F1C40F",       # Gold
"2nd Place" = "#95A5A6",       # Silver (Made slightly darker for visibility)
"3rd Place" = "#D35400",       # Bronze
"Top 5 Runners-up" = "#2C3E50" # Dark Blue
)) +
# Add labels inside the bars
geom_text(aes(label = transaction_count), hjust = 1.5, color = "white", fontface = "bold") +
coord_flip() +
labs(
title = "Top 5 Most Active Users",
subtitle = "Users with the highest transaction frequency",
x = "User ID",
y = "Number of Transactions",
fill = "Rank"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16),
legend.position = "bottom",
panel.grid.major.y = element_blank()
)
# 5. Save
print(plot)
ggsave("presentation_plots/6_top_users_ranked.png", plot, width = 8, height = 6)
# 6. Close Connection
dbDisconnect(conn)
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("plot_credit_scores.R")
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("plot_credit_scores.R")
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("R/plot_credit_scores.R")
print("   [2/6] Generating Category Volume Chart...")
source("R/plot_category_volume.R")
print("   [3/6] Generating Risk Lollipop Chart...")
source("R/plot_risk_rank.R")
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Helper function to run scripts inside the 'R' folder
run_script_safely <- function(script_name) {
# Construct the path: R/script_name.R
file_path <- file.path("R", script_name)
if (file.exists(file_path)) {
print(paste("   [Running]", script_name, "..."))
source(file_path)
} else {
print(paste("   [ERROR] File missing:", file_path))
print("   -> Please check if you saved this file in the 'R' folder with this exact name.")
}
}
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("R/plot_credit_scores.R")
print("   [2/6] Generating Category Volume Chart...")
source("R/plot_category_volume.R")
print("   [3/6] Generating Risk Lollipop Chart...")
source("R/plot_risk_category.R")
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Helper function to run scripts inside the 'R' folder
run_script_safely <- function(script_name) {
# Construct the path: R/script_name.R
file_path <- file.path("R", script_name)
if (file.exists(file_path)) {
print(paste("   [Running]", script_name, "..."))
source(file_path)
} else {
print(paste("   [ERROR] File missing:", file_path))
print("   -> Please check if you saved this file in the 'R' folder with this exact name.")
}
}
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("R/plot_credit_scores.R")
print("   [2/6] Generating Category Volume Chart...")
source("R/plot_category_volume.R")
print("   [3/6] Generating Risk Lollipop Chart...")
source("R/plot_risk_by_category.R")
print("   [4/6] Generating Latest User Activity Scatter Plot...")
source("R/plot_latest_user_activity.R")
print("   [5/6] Generating Daily Trend Area Chart...")
source("R/plot_daily_trend.R")
print("   [6/6] Generating Top Users Ranked Bar Chart...")
source("R/plot_top_users.R")
print("==========================================")
print(">>> SUCCESS! All charts saved to 'presentation_plots' folder.")
print("==========================================")
library(DBI)
library(RSQLite)
library(tidyverse)
library(scales)
print(">>> STARTING CHART GENERATION...")
#Helper function to run scripts inside the 'R' folder
run_script_safely <- function(script_name) {
# Construct the path: R/script_name.R
file_path <- file.path("R", script_name)
if (file.exists(file_path)) {
print(paste("   [Running]", script_name, "..."))
source(file_path)
} else {
print(paste("   [ERROR] File missing:", file_path))
print("   -> Please check if you saved this file in the 'R' folder with this exact name.")
}
}
#Run Individual Chart Scripts
print("   [1/6] Generating Credit Score Distribution...")
source("R/plot_credit_scores.R")
print("   [2/6] Generating Category Volume Chart...")
source("R/plot_category_volume.R")
print("   [3/6] Generating Risk Lollipop Chart...")
source("R/plot_risk_by_category.R")
print("   [4/6] Generating Latest User Activity Scatter Plot...")
source("R/plot_latest_user_activity.R")
print("   [5/6] Generating Daily Trend Area Chart...")
source("R/plot_daily_trend.R")
print("   [6/6] Generating Top Users Ranked Bar Chart...")
source("R/plot_top_users.R")
print("==========================================")
print(">>> SUCCESS! All charts saved to 'presentation_plots' folder.")
print("==========================================")
