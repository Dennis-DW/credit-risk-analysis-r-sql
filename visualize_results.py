import matplotlib.pyplot as plt
import numpy as np
import json
import os

def generate_charts():
    # Load the results generated by the previous script
    json_path = 'data/validation_summary.json'
    
    if not os.path.exists(json_path):
        print(f"Error: '{json_path}' not found. Run python_validation.py first!")
        return

    with open(json_path, 'r') as f:
        data = json.load(f)

    # Extract Data
    dq = data['data_quality']
    acc = data['accuracy']
    err = data['error_breakdown']

    # --- PLOTTING ---
    fig, (ax1, ax2, ax3) = plt.subplots(1, 3, figsize=(18, 5))
    fig.suptitle(f"Validation Results (Accuracy: {acc['percent']}%)", fontsize=16, fontweight='bold', color='#2C3E50')

    # Chart 1: Data Quality
    bars = ax1.bar(dq['labels'], dq['values'], color=['#E74C3C', '#95A5A6', '#95A5A6'])
    ax1.set_title('Data Quality Issues', fontsize=12, fontweight='bold')
    ax1.set_ylim(0, max(dq['values']) + 5 if dq['values'] else 10)
    # Add labels
    for bar in bars:
        height = bar.get_height()
        if height > 0:
            ax1.text(bar.get_x() + bar.get_width()/2., height + 0.1, f'{int(height)}', 
                     ha='center', va='bottom', fontweight='bold', color='#E74C3C')

    # Chart 2: Accuracy
    ax2.pie([acc['correct'], acc['errors']], labels=['Correct', 'Errors'], autopct='%1.1f%%', 
            startangle=140, colors=['#2ECC71', '#E74C3C'], explode=(0, 0.1))
    ax2.set_title('Model Performance', fontsize=12, fontweight='bold')

    # Chart 3: Top Errors
    # Handle case where there are no errors
    if err['categories']:
        y_pos = np.arange(len(err['categories']))
        ax3.barh(y_pos, err['counts'], color='#3498DB')
        ax3.set_yticks(y_pos)
        ax3.set_yticklabels(err['categories'])
        ax3.invert_yaxis()
        ax3.set_xlabel('Count of Misclassifications')
    else:
        ax3.text(0.5, 0.5, "No Errors Found!", ha='center', fontsize=12)
    
    ax3.set_title('Problematic Categories', fontsize=12, fontweight='bold')

    # Save
    output_img = 'presentation_plots/part3_summary_charts.png'
    plt.tight_layout()
    plt.savefig(output_img)
    print(f"Charts saved as '{output_img}'")
    plt.show()

if __name__ == "__main__":
    generate_charts()
